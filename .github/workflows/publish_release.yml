name: publish to NuGet

on:
  push:
    tags:
      - 'releases/*'

jobs:
  publish:

    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        # This is necessary so that we have the tags.
        fetch-depth: 0

    - name: Set Build Version
      run: |
        $version = "$env:GITHUB_REF_NAME"
        $File = (
          Select-Xml -XPath "/Project/PropertyGroup/Version" -Path "src/FSharp.Collections.Immutable/FSharp.Collections.Immutable.fsproj"
        )[0].Node
        $File.InnerText = $version
        $File.OwnerDocument.Save((Join-Path $PWD.ProviderPath src/FSharp.Collections.Immutable/FSharp.Collections.Immutable.fsproj))
        echo "VERSION=$version" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
      shell: pwsh

    - name: Install .NET Core
      uses: actions/setup-dotnet@v3

    - name: Pack FSharp.Collections.Immutable project
      run: |
        dotnet pack --nologo --configuration Release -o nuget

    - name: Publish FSharp.Collections.Immutable project to GitHub
      run: |
        dotnet nuget push nuget/FSharp.Collections.Immutable*.nupkg -k ${{secrets.NUGET_SECRET}}
