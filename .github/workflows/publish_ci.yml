name: publish to GitHub

on:
  push:
    branches:
      - develop

jobs:
  publish:

    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Set Build Version
      run: |
        $File = (
          Select-Xml -XPath "/Project/PropertyGroup/Version" -Path "src/FSharp.Collections.Immutable/FSharp.Collections.Immutable.fsproj"
        )[0].Node
        $version = "$($File.InnerText)-ci-$Env:GITHUB_RUN_ID"
        $File.InnerText = $version
        $File.OwnerDocument.Save((Join-Path $PWD.ProviderPath src/FSharp.Collections.Immutable/FSharp.Collections.Immutable.fsproj))
        echo "VERSION=$version" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
      shell: pwsh

    - name: Install .NET Core
      uses: actions/setup-dotnet@v3

    - name: Add the GitHub source
      run: dotnet nuget add source --username USERNAME --password ${{secrets.GITHUB_TOKEN}} --store-password-in-clear-text --name github "https://nuget.pkg.github.com/fsprojects/index.json"

    - name: Pack FSharp.Collections.Immutable project
      run: |
        dotnet pack --nologo --configuration Release -o nuget

    - name: Publish FSharp.Collections.Immutable project to GitHub
      run: |
        dotnet nuget push nuget/FSharp.Collections.Immutable*.nupkg -s "github" -k ${{secrets.GITHUB_TOKEN}}
